#!/bin/bash
MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "${MYDIR}/.."
set -e

# Carica il file .env se esiste
if [ -f .env ]; then
    source .env
fi

# Imposta il nome del volume con un valore predefinito
RRSYNC_VOLUME="${RRSYNC_VOLUME:-rrsync-archives}"

# Controlli per RRSYNC_VOLUME_PATH
if [ -z "${RRSYNC_VOLUME_PATH}" ]; then
    echo "Errore: RRSYNC_VOLUME_PATH non è definito. Imposta la variabile nel file .env o come variabile d'ambiente."
    exit 1
fi

if [ ! -d "${RRSYNC_VOLUME_PATH}" ]; then
    echo "Errore: Il percorso ${RRSYNC_VOLUME_PATH} non esiste o non è una directory."
    exit 1
fi

if [ ! -r "${RRSYNC_VOLUME_PATH}" ] || [ ! -w "${RRSYNC_VOLUME_PATH}" ]; then
    echo "Errore: Il percorso ${RRSYNC_VOLUME_PATH} non ha permessi di lettura/scrittura."
    exit 1
fi

# Controlla se il volume esiste già (opzionale)
if docker volume ls -q | grep -Fx "${RRSYNC_VOLUME}" > /dev/null; then
    echo "Attenzione: Il volume ${RRSYNC_VOLUME} esiste già."
    # Puoi scegliere di uscire con un errore o continuare
    # exit 1
fi

# Crea il volume
docker volume create \
       --driver local \
       --opt type=none \
       --opt device="${RRSYNC_VOLUME_PATH}" \
       --opt o=bind \
       "${RRSYNC_VOLUME}"

echo "Volume ${RRSYNC_VOLUME} creato con successo, associato a ${RRSYNC_VOLUME_PATH}."
