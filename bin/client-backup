#!/bin/bash

set -e

# Configurazione
export ARCHIVE_NAME="${1:-project-backup}"
LOCAL_PATH="${2:-./data/}"
REMOTE_HOST="localhost"
REMOTE_PORT="2222"
RSYNC_OPTS="-avz --progress --partial --append"

# Validate inputs
if [ -z "$ARCHIVE_NAME" ]; then
    echo "Usage: $0 <archive_name> [local_path]"
    echo "Example: $0 project-backup ./mydata/"
    exit 1
fi

if [ ! -d "$LOCAL_PATH" ]; then
    echo "Error: Local path '$LOCAL_PATH' does not exist"
    exit 1
fi

echo "Starting backup..."
echo "  Archive: $ARCHIVE_NAME.tar.zst"
echo "  Source: $LOCAL_PATH"
echo "  Destination: rsync-server:$REMOTE_PORT"

# Execute rsync
rsync $RSYNC_OPTS \
  -e "ssh -vvv -o SendEnv=ARCHIVE_NAME -p $REMOTE_PORT" \
  "$LOCAL_PATH" \
  "rrsync@$REMOTE_HOST:/dummy/"

echo "âœ“ Backup completed: $ARCHIVE_NAME.tar.zst"
