#!/bin/sh

set -e

addgroup -g ${RRSYNC_GID} rrsync
adduser -u ${RRSYNC_UID} -G rrsync -D rrsync
passwd -u rrsync

[ -d /tmp/rrsync ] || mkdir /tmp/rrsync
chown rrsync:rrsync /archives /tmp/rrsync

# FIFO ttsync-wrapper
export LOG_FIFO=/tmp/rrsync.fifo
mkfifo ${LOG_FIFO}
chown root:rrsync ${LOG_FIFO}
chmod 0460 ${LOG_FIFO}
tail -n +0 -f ${LOG_FIFO} &

cd /home/rrsync
su rrsync -s /bin/sh /usr/local/bin/rrsync-wrapper-init

# Start SSH daemon
cd /
echo "Starting SSH daemon..."
exec /usr/sbin/sshd -D -e
