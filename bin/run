#!/bin/bash
MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "${MYDIR}/.."
set -e

if [ -f .env ]; then
    source .env
fi

# Configuration with defaults
DOCKER_REPO="${DOCKER_REPO:-andzuc/rrsync-server}"
DOCKER_VERSION="${DOCKER_VERSION:-latest}"
RRSYNC_ARCHIVES="${RRSYNC_ARCHIVES:-rrsync-archives}"
RRSYNC_TMP="${RRSYNC_TMP:-rrsync-tmp}"
GPG_KEYID="${GPG_KEYID:-}"

# Validate required variables
if [ -z "$GPG_KEYID" ]; then
    echo "Error: GPG_KEYID environment variable is required"
    echo "Set it with: export GPG_KEYID=ABC123DEF456"
    exit 1
fi

# Ensure RRSYNC_ARCHIVES volume exists
if ! docker volume inspect "${RRSYNC_ARCHIVES}" >/dev/null 2>&1 ; then
    echo docker volume create "${RRSYNC_ARCHIVES}"
    docker volume create "${RRSYNC_ARCHIVES}"
fi
docker volume inspect "${RRSYNC_ARCHIVES}"

# Ensure RRSYNC_TMP volume exists
if ! docker volume inspect "${RRSYNC_TMP}" >/dev/null 2>&1 ; then
    echo docker volume create "${RRSYNC_TMP}"
    docker volume create "${RRSYNC_TMP}"
fi
docker volume inspect "${RRSYNC_TMP}"

# Start container
echo "Starting rrsync-server..."
echo "  Repository: ${DOCKER_REPO}:${DOCKER_VERSION}"
echo "  Archives volume: ${RRSYNC_ARCHIVES}"
echo "  Tmp volume: ${RRSYNC_TMP}"
echo "  GPG Key: ${GPG_KEYID}"
echo "  Port: 2222"

docker run --rm -d \
       -p 2222:22 \
       --mount type=volume,source="${RRSYNC_ARCHIVES}",target=/archives \
       --mount type=volume,source="${RRSYNC_TMP}",target=/tmp/rrsync \
       -e GPG_KEYID="${GPG_KEYID}" \
       --name rrsync-server \
       "${DOCKER_REPO}:${DOCKER_VERSION}" \
       "$@"

# Health check
if [ $? -eq 0 ]; then
    echo "✓ rrsync-server started successfully!"
    echo "  Container ID: $(docker ps --filter name=rrsync-server -q)"
    echo "  Logs: docker logs rrsync-server"
    echo "  Connect: rsync -avz -e 'ssh -o SendEnv=ARCHIVE_NAME=newarchive -p 2222' /local/path/ root@localhost:/dummy/"
    echo "  Archives volume: docker volume inspect ${RRSYNC_ARCHIVES}"
    echo "  Tmp volume: docker volume inspect ${RRSYNC_TMP}"
else
    echo "✗ Failed to start rrsync-server"
    exit 1
fi
