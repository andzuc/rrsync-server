#!/bin/sh -x
#https://grok.com/share/c2hhcmQtNA%3D%3D_602141ed-3932-415c-a3ad-4473ee8e83ec

# Open a file descriptor for logging
exec 2>>"${LOG_FIFO}"
exec 3>>"${LOG_FIFO}"

# Log function to send messages to the log
log() {
    echo "$(basename $0): $@" >&3
}

ARCHIVE_NAME="${ARCHIVE_NAME:-$1}"
TEMP_DIR="/tmp/rrsync/backup_${ARCHIVE_NAME}"
ARCHIVE_PATH="/archives/${ARCHIVE_NAME}"

# Check if ARCHIVE_NAME is empty
if [ -z "$ARCHIVE_NAME" ]; then
    log "Error: Archive name not specified."
    echo "Error: Archive name not specified." >&2  # Send error to stderr for client visibility
    exit 1
fi

# Add .tar.zst if not present, otherwise verify it's .tar.zst
if echo "$ARCHIVE_NAME" | grep -q "\.tar\.zst$"; then
    ARCHIVE_PATH="/archives/$ARCHIVE_NAME"
else
    if echo "$ARCHIVE_NAME" | grep -q "\.tar\."; then
        log "Error: Invalid extension. Only .tar.zst is allowed."
        echo "Error: Invalid extension. Only .tar.zst is allowed." >&2
        exit 1
    fi
    ARCHIVE_NAME="${ARCHIVE_NAME}.tar.zst"
    ARCHIVE_PATH="/archives/$ARCHIVE_NAME"
fi

# Validate name (exclude dangerous characters)
if ! echo "$ARCHIVE_NAME" | grep -q "^[a-zA-Z0-9_.-]\+\.tar\.zst$"; then
    log "Error: Invalid archive name."
    echo "Error: Invalid archive name." >&2
    exit 1
fi

# Create temp dir if it doesn't exist
mkdir -p "$TEMP_DIR"
TEMP_DIR_TIME="${TEMP_DIR}.time"

# If archive exists AND temp dir is empty, decompress it
if [ -f "$ARCHIVE_PATH" ] && [ ! "$(ls -A "$TEMP_DIR")" ]; then
    log "Archive $ARCHIVE_PATH exists and temp dir is empty, decompressing."
    tar -I zstd -xf "$ARCHIVE_PATH" -C "$TEMP_DIR"
    log "Decompression complete. Temp dir now contains $(find "$TEMP_DIR" | wc -l) files/directories."
    touch $TEMP_DIR_TIME
    TEMP_DIR_MODIFIED=0
elif [ -f "$ARCHIVE_PATH" ]; then
    log "Archive $ARCHIVE_PATH exists but temp dir already has $(find "$TEMP_DIR" | wc -l) files/directories."
    log "Rsync will merge client files with existing archive content."
    touch $TEMP_DIR_TIME
    TEMP_DIR_MODIFIED=1
else
    log "No existing archive, temp dir is ready for client files."
    touch $TEMP_DIR_TIME
    TEMP_DIR_MODIFIED=1
fi
sleep 2 # find has 1 second resolution

TEMP_DIR_NUM="$(find "$TEMP_DIR" | wc -l)"
log "Temp directory ready at $TEMP_DIR"
log "Current contents: $TEMP_DIR_NUM items"

# Call rrsync in read-write mode on temp dir (no redirection for output, as it's needed for protocol)
log "Starting rsync session on $TEMP_DIR"
log "Client can resume with --partial --append if interrupted"
/usr/bin/rrsync "$TEMP_DIR/"
RSYNC_EXIT=$?

log "Rsync session ended with exit code $RSYNC_EXIT"
log "Temp dir now contains $(find "$TEMP_DIR" | wc -l) files/directories."

if [ $TEMP_DIR_MODIFIED -eq 0 ]; then
    if find "$TEMP_DIR" -newer "$TEMP_DIR_TIME" -print -quit 2>/dev/null|grep -q .; then
	TEMP_DIR_MODIFIED=1
    fi
fi

# If rsync succeeded, create compressed tarball and clean temp dir
if [ $RSYNC_EXIT -eq 0 ]; then
    if [ $TEMP_DIR_MODIFIED -eq 1 ]; then
	log "Rsync completed successfully, creating compressed archive $ARCHIVE_PATH."
	if tar -C "$TEMP_DIR" --use-compress-program=zstd -cf "$ARCHIVE_PATH" .; then
            log "Archive created successfully: $ARCHIVE_PATH ($(du -sh "$ARCHIVE_PATH"))"
            # Clean up temp dir only on successful completion
	    rm -rf "$TEMP_DIR"
	    rm "$TEMP_DIR_TIME"
	    log "Temporary directory cleaned up."
	else
            log "Error: Failed to create archive $ARCHIVE_PATH"
            log "Keeping temporary directory $TEMP_DIR for manual inspection"
            exit 1
	fi
    else
	log "Rsync completed successfully, no file was modified"
	rm -rf "$TEMP_DIR"
	rm "$TEMP_DIR_TIME"
	log "Temporary directory cleaned up."
    fi
else
    log "Rsync failed or was interrupted (exit code $RSYNC_EXIT)"
    log "Keeping temporary directory $TEMP_DIR for client resumption"
    log "Client should resume with: rsync --partial --append ..."
    exit $RSYNC_EXIT
fi

log "Process completed successfully."
